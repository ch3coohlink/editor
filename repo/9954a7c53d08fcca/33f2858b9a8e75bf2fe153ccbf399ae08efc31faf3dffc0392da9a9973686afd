{"id":"33f2858b9a8e75bf2fe153ccbf399ae08efc31faf3dffc0392da9a9973686afd","to":[],"value":"Object.assign($, await require('lib/common.js'))\r\nObject.assign($, await require('comp.js'))\r\nroot.style.overflow = 'hidden'\r\nconsole.clear()\r\n\r\n$.framecount = 0\r\nconst loop = () => {\r\n  if ($.frame) { framecount++; frame() }\r\n  requestAnimationFrame(loop)\r\n}; requestAnimationFrame(loop)\r\n\r\n$.dragprocess = (move, cancel) => {\r\n  const c = e => (off('pointermove', mi),\r\n    off('pointerup', ui), off('pointercancel', ci), cancel?.(e))\r\n  const mi = on('pointermove', move)\r\n  const ui = on('pointerup', c)\r\n  const ci = on('pointercancel', c)\r\n}\r\n$.expdecay = (a, b, d, dt) => b + (a - b) * Math.exp(-d * dt)\r\n$.formatkeyevent = (e, up) => e.key.toLowerCase() + (up ? 'up' : [\r\n  e.altKey, e.ctrlKey, e.shiftKey].map(v => v ? 't' : 'f').join(''))\r\n\r\n{\r\n  // TODO: \r\n  const { max, min } = Math; $.clamp = (v, s, l) => max(min(v, l), s)\r\n  $.itp = (a, b, t) => (t = clamp(t, 0, 1), a + t * (b - a))\r\n  $.itp3 = (a, b, t) => (t = clamp(t, 0, 1),\r\n    [a[0] + t * (b[0] - a[0]), a[1] + t * (b[1] - a[1]), a[2] + t * (b[2] - a[2])])\r\n\r\n  $.callhotkey = (m, k, e) => {\r\n    while (m) {\r\n      if (m._hotkey[k]) {\r\n        return m._hotkey[k]?.(e)\r\n      } m = m.parent\r\n    }\r\n  }\r\n}\r\n\r\nroot.setAttribute('style', `display:flex;height:100%;`)\r\nconst strip = { a: '#aaa', b: '#777', c: 15 }\r\nroot.append(\r\n  $.modeleditor = h('textarea', {\r\n    js: {\r\n      onchange: () => { reload() },\r\n      onkeydown: e => {\r\n        if (formatkeyevent(e) !== 'sftf') { return }\r\n        e.preventDefault()\r\n        save()\r\n      },\r\n    }, style: `resize:horizontal;white-space:pre;width:30%;\r\n      font-family:consolas;font-size:12px;`\r\n  }),\r\n  h('div', {\r\n    style: `width:70%;\r\n      background: repeating-linear-gradient(\r\n        -45deg, ${strip.a}, ${strip.a} ${strip.c}px,\r\n        ${strip.b} ${strip.c}px, ${strip.b} ${strip.c * 2}px);\r\n      display: flex; justify-content: center; align-items: center;`\r\n  },\r\n    $.sandbox = h('div', {\r\n      style: `resize:both;overflow:hidden;\r\n        width:calc(100% - 50px);height:calc(100% - 50px);\r\n        max-width:calc(100% - 10px);max-height:calc(100% - 10px);\r\n        box-shadow: 0 0 10px #494949;\r\n        background:white;`\r\n    })\r\n  )\r\n)\r\n\r\nconst compdir = await read('comp', { raw: true })\r\nconst version = $$.vcs.getversion(compdir)\r\nlet filelist; const reload = async (first) => {\r\n  const od = component.definition; component.definition = {}\r\n  const d = await dir('comp'); await Promise.all(d.map(n =>\r\n    require('comp/' + n, { forceload: true, watch: false })))\r\n  filelist = new Set(await Promise.all(d.map(n =>\r\n    read('comp/' + n, { raw: true }).then(a => a.id))))\r\n  if (first) { await rebuildall() } else {\r\n    const ks = Object.keys(component.definition)\r\n    const changed = { model: new Set, view: new Set }\r\n    for (const k of ks) {\r\n      const mc = !deepequal(od[k]?.model, component.definition[k].model)\r\n      const vc = String(od[k]?.view) !== String(component.definition[k].view)\r\n      if (mc) { changed.model.add(k) } if (vc) { changed.view.add(k) }\r\n    } await rebuild(changed)\r\n  } if (!component.root) { return }\r\n  sb.env.root.append(component.root._view)\r\n}\r\nconst rebuild = async changed => {\r\n  if (!component.root) { return }\r\n  let q = [component.root], m, mc = q[0]\r\n  while (m = q.pop()) {\r\n    if (changed.model.has(m.type)) { mc = true; break }\r\n    for (const e of m._view.childNodes) {\r\n      const c = e._comp; if (!c) { continue } q.push(c)\r\n    }\r\n  }\r\n  if (mc) {\r\n    await rebuildall()\r\n  } else {\r\n    let q = [component.root], m; while (m = q.pop()) {\r\n      if (!changed.view.has(m.type)) { continue }\r\n      const ov = m._view; component.render(m)\r\n      ov.replaceWith(m._view)\r\n      for (const e of m._view.childNodes) {\r\n        const c = e._comp; if (!c) { continue } q.push(c)\r\n      }\r\n    }\r\n  }\r\n}\r\nconst rebuildall = () => sb.exec({ component })\r\n\r\nconst getfile = () => {\r\n  const i = '61788816003b7d997ec97e6c855e' +\r\n    '92dd405fd174d7e12171773473c90d7fd4e1'\r\n  return ['virtual.js', modeleditor.value, i, [version.id]]\r\n}, sb = $$.sandboxtab($$.vcs, { type: 'virtual', getfile })\r\nsb.registersandboxclear($)\r\nsandbox.append(sb)\r\n\r\nconst save = () => { }\r\nconst load = async () => { }\r\n\r\nmodeleditor.value = `\r\nawait require('0/lib/common.js')\r\ncomponent.root = component.create('placeincenter',\r\n  m => m.child = component.create('button'))\r\n`.trim()\r\n\r\nawait load()\r\nawait reload(true)\r\n\r\non('file change', ({ o }) => {\r\n  if (o.id === compdir.id || filelist.has(o.id)) { reload() }\r\n})\r\n\r\nlet pt = now(); $.frame = () => {\r\n  const t = now(), dt = t - pt; pt = t\r\n}"}